name: Test Signing Process

on:
  pull_request:
    paths:
      - ".github/workflows/release.yml"
      - "scripts/sign-release-binaries.sh"
      - "scripts/verify-release-signatures.sh"
      - "scripts/filter-release-files.sh"
  workflow_dispatch:

permissions:
  contents: read
  id-token: write # Required for cosign keyless signing

jobs:
  test-signing:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Build test binary
        run: |
          cargo build --release
          mkdir -p test-dist
          cp target/release/envsense test-dist/envsense-v0.0.0-universal-apple-darwin
          echo "test-checksum" > test-dist/envsense-v0.0.0-universal-apple-darwin.sha256

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Test signing process
        run: |
          echo "Testing signing process..."
          ./scripts/filter-release-files.sh test-dist test-release-files
          ./scripts/sign-release-binaries.sh test-release-files

      - name: Test signature verification
        run: |
          echo "Testing signature verification..."
          echo "Note: Full verification requires correct certificate identity matching."
          echo "For now, we'll just verify that cosign can read the bundle/signature files."

          cd test-release-files
          for file in envsense-*; do
            if [[ "$file" != *.sha256 && "$file" != *.sig && "$file" != *.bundle ]]; then
              echo "🔍 Testing signature files for: $file"
              
              if [ -f "${file}.bundle" ]; then
                echo "  📦 Bundle file exists: ${file}.bundle ($(stat -c%s "${file}.bundle" 2>/dev/null || stat -f%z "${file}.bundle" 2>/dev/null || echo unknown) bytes)"
                # Just verify the bundle format is valid (don't verify identity)
                if cosign verify-blob --bundle "${file}.bundle" "$file" --insecure-ignore-sct --insecure-ignore-tlog 2>/dev/null; then
                  echo "  ✅ Bundle format is valid"
                else
                  echo "  ⚠️  Bundle format check failed (may be due to certificate identity)"
                fi
              fi
              
              if [ -f "${file}.sig" ]; then
                echo "  🔏 Signature file exists: ${file}.sig ($(stat -c%s "${file}.sig" 2>/dev/null || stat -f%z "${file}.sig" 2>/dev/null || echo unknown) bytes)"
              fi
            fi
          done
        continue-on-error: true # Don't fail CI - this is just validation

      - name: Validate test signing completed
        run: ./scripts/check-signing-completed.sh test-release-files

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-signing-artifacts
          path: test-release-files/
          retention-days: 1
