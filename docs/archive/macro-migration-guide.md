# Macro Migration Guide

This guide explains how to migrate from manual detection merging to the new macro-based approach.

## Overview

The macro-based approach replaces 80+ lines of manual merging logic with automatic field mapping, reducing complexity by 60-80% while maintaining full functionality.

## Before: Manual Merging

```rust
// Old approach: Manual merging in engine.rs
impl DetectionEngine {
    pub fn detect_from_snapshot(&self, snapshot: &EnvSnapshot) -> EnvSense {
        let mut result = EnvSense::default();
        let detections: Vec<Detection> = self.detectors
            .iter()
            .map(|detector| detector.detect(snapshot))
            .collect();
        
        // Manual merging logic (80+ lines)
        let mut all_contexts = std::collections::HashSet::new();
        let mut all_traits: HashMap<String, serde_json::Value> = HashMap::new();
        let mut all_facets: HashMap<String, serde_json::Value> = HashMap::new();
        
        for detection in &detections {
            all_contexts.extend(detection.contexts_add.iter().cloned());
            all_traits.extend(detection.traits_patch.clone());
            all_facets.extend(detection.facets_patch.clone());
            result.evidence.extend(detection.evidence.clone());
        }
        
        // Manual field mapping
        result.contexts.agent = all_contexts.contains("agent");
        result.contexts.ide = all_contexts.contains("ide");
        result.contexts.ci = all_contexts.contains("ci");
        result.contexts.container = all_contexts.contains("container");
        result.contexts.remote = all_contexts.contains("remote");
        
        if let Some(value) = all_facets.get("agent_id").and_then(|v| v.as_str()) {
            result.facets.agent_id = Some(value.to_string());
        }
        // ... 60+ more lines of manual mapping
        
        result
    }
}
```

## After: Macro-Based Merging

```rust
// New approach: Automatic merging with macro
use envsense_macros::{DetectionMergerDerive, DetectionMerger};

#[derive(DetectionMergerDerive)]
pub struct EnvSense {
    pub contexts: Contexts,      // Automatically maps to contexts_add
    pub facets: Facets,         // Automatically maps to facets_patch
    pub traits: Traits,         // Automatically maps to traits_patch
    pub evidence: Vec<Evidence>, // Automatically maps to evidence
    pub version: String,        // Ignored (no mapping)
}

impl DetectionEngine {
    pub fn detect_from_snapshot(&self, snapshot: &EnvSnapshot) -> EnvSense {
        let mut result = EnvSense::default();
        let detections: Vec<Detection> = self.detectors
            .iter()
            .map(|detector| detector.detect(snapshot))
            .collect();
        
        // Automatic merging (1 line!)
        result.merge_detections(&detections);
        result
    }
}
```

## Migration Steps

### Step 1: Add Macro Dependencies

The macro dependencies are already included in the workspace. No changes needed.

### Step 2: Update Struct Definition

Add the derive macro to your struct:

```rust
// Before
pub struct EnvSense {
    pub contexts: Contexts,
    pub facets: Facets,
    pub traits: Traits,
    pub evidence: Vec<Evidence>,
    pub version: String,
}

// After
use envsense_macros::DetectionMergerDerive;

#[derive(DetectionMergerDerive)]
pub struct EnvSense {
    pub contexts: Contexts,
    pub facets: Facets,
    pub traits: Traits,
    pub evidence: Vec<Evidence>,
    pub version: String,
}
```

### Step 3: Update Engine Implementation

Replace manual merging with macro-generated merging:

```rust
// Before: Manual merging
let mut all_contexts = std::collections::HashSet::new();
let mut all_traits: HashMap<String, serde_json::Value> = HashMap::new();
let mut all_facets: HashMap<String, serde_json::Value> = HashMap::new();

for detection in &detections {
    all_contexts.extend(detection.contexts_add.iter().cloned());
    all_traits.extend(detection.traits_patch.clone());
    all_facets.extend(detection.facets_patch.clone());
    result.evidence.extend(detection.evidence.clone());
}

// Manual field mapping (80+ lines)
result.contexts.agent = all_contexts.contains("agent");
// ... more manual mapping

// After: Automatic merging
use envsense_macros::DetectionMerger;

result.merge_detections(&detections);
```

### Step 4: Remove Manual Helper Functions

Remove the manual helper functions that are no longer needed:

```rust
// Remove these functions (they're now generated by the macro)
impl DetectionEngine {
    fn set_context_bool(contexts: &mut Contexts, key: &str, all_contexts: &HashSet<String>) { /* ... */ }
    fn set_facet_id(facet_id: &mut Option<String>, key: &str, all_facets: &HashMap<String, serde_json::Value>) { /* ... */ }
    fn set_trait_bool(trait_value: &mut bool, key: &str, all_traits: &HashMap<String, serde_json::Value>) { /* ... */ }
}
```

## Field Mapping Rules

The macro automatically maps fields based on their names:

| Field Name | Maps To | Description |
|------------|---------|-------------|
| `contexts` | `contexts_add` | Boolean context flags |
| `facets` | `facets_patch` | String and struct facets |
| `traits` | `traits_patch` | Boolean and enum traits |
| `evidence` | `evidence` | Evidence collection |
| Any other name | Ignored | No mapping applied |

## Type Support

The macro handles various field types automatically:

### Boolean Fields
```rust
pub contexts: Contexts {
    pub agent: bool,    // Maps from contexts_add.contains("agent")
    pub ide: bool,      // Maps from contexts_add.contains("ide")
}
```

### String Fields
```rust
pub facets: Facets {
    pub agent_id: Option<String>,  // Maps from facets_patch.get("agent_id")
    pub ide_id: Option<String>,    // Maps from facets_patch.get("ide_id")
}
```

### Enum Fields
```rust
pub traits: Traits {
    pub color_level: ColorLevel,  // Maps from traits_patch.get("color_level")
}
```

### Struct Fields
```rust
pub facets: Facets {
    pub ci: CiFacet,  // Maps from facets_patch.get("ci") with JSON deserialization
}
```

### Collection Fields
```rust
pub evidence: Vec<Evidence>,  // Extends with evidence from all detections
```

## Benefits

### Code Reduction
- **Before**: 80+ lines of manual merging logic
- **After**: ~20 lines of macro annotations
- **Reduction**: 60-80% less code

### Maintainability
- **Before**: Adding new fields requires manual updates in multiple places
- **After**: Adding new fields only requires struct definition changes

### Type Safety
- **Before**: String-based field matching prone to typos
- **After**: Compile-time validation of field mappings

### Performance
- **Before**: Manual HashMap operations and string comparisons
- **After**: Optimized generated code with same performance characteristics

## Testing

After migration, run the test suite to ensure everything works correctly:

```bash
cargo test
```

The macro includes comprehensive tests for:
- Basic field mapping
- Complex type handling
- Performance benchmarking
- Integration with the detection engine

## Troubleshooting

### Common Issues

1. **"cannot find trait DetectionMerger"**
   - Ensure you've imported `use envsense_macros::DetectionMerger;`

2. **"field not found" errors**
   - Check that field names match the expected mapping rules
   - Ensure field types are supported by the macro

3. **"expected struct, found enum" errors**
   - The macro only works on structs, not enums

### Getting Help

If you encounter issues during migration:
1. Check the macro documentation in `envsense-macros/src/lib.rs`
2. Review the test examples in `tests/macro_*.rs`
3. Ensure all dependencies are properly configured

## Conclusion

The macro-based approach significantly reduces complexity while maintaining full functionality. The migration is straightforward and provides immediate benefits in code maintainability and type safety.
